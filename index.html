<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>交易流程化工具 V2.2</title>
  <style>
    :root {
      --bg-color: #1a1a1a;
      --surface-color: #2b2b2b;
      --primary-color: #007bff;
      --text-color: #e0e0e0;
      --disabled-color: #555;
      --red-color: #dc3545;
      --green-color: #28a745;
      --yellow-color: #f0ad4e;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      font-size: 16px;
    }

    .container { max-width: 980px; margin: auto; }
    header { background-color: var(--surface-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
    #daily-plan-display { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px; }
    #daily-plan-display span { margin: 0; padding: 8px 12px; border-radius: 20px; background-color: #3a3a3a; font-weight: bold; }

    .main-controls { text-align: center; margin-bottom: 18px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) { background-color: #0056b3; }
    button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }

    .ghost-btn { background: transparent; border: 1px solid #666; }
    .ghost-btn:hover:not(:disabled) { background: rgba(255,255,255,0.06); }

    .trade-section { margin-top: 16px; }
    h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }

    .trade-card {
      background-color: var(--surface-color);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 5px solid var(--primary-color);
    }
    .trade-card.completed { border-left-color: var(--disabled-color); }
    .trade-card.violation { border-left-color: var(--red-color); }
    .trade-card p { margin: 6px 0; }
    .trade-card .muted { color: #bdbdbd; font-size: 14px; }

    .kv { display: grid; grid-template-columns: 120px 1fr; gap: 8px; align-items: start; }

    .review-notes { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #555; }
    .review-notes p { font-weight: bold; margin-bottom: 6px; }

    dialog {
      width: 92%;
      max-width: 680px;
      background-color: var(--surface-color);
      color: var(--text-color);
      border: 1px solid #555;
      border-radius: 8px;
      padding: 22px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }
    dialog::backdrop { background: rgba(0, 0, 0, 0.7); }
    dialog h3 { margin-top: 0; }

    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], select {
      width: calc(100% - 22px);
      padding: 10px;
      background-color: #333;
      border: 1px solid #555;
      color: var(--text-color);
      border-radius: 4px;
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > .col { flex: 1 1 250px; }

    .custom-input { display: none; margin-top: 10px; }

    .checkbox-group label { display: flex; align-items: center; cursor: pointer; gap: 10px; }
    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; }

    .position-calculator {
      background-color: #1f1f1f;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      border: 1px solid #444;
    }
    .position-calculator .calc-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px; }
    .position-calculator .calc-row label { flex-basis: 42%; }
    .position-calculator .calc-row input, .position-calculator .calc-row select { flex-basis: 55%; }

    .position-calculator .result {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #555;
      text-align: center;
    }
    .position-calculator .result h4 { margin: 0 0 10px 0; }
    .position-calculator .result .big { font-size: 26px; font-weight: bold; margin: 6px 0; color: var(--green-color); }
    .result-details { display: flex; justify-content: space-around; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .result-details div { text-align: center; min-width: 120px; }
    .result-details div small { color: #aaa; }

    .banner {
      background: rgba(240, 173, 78, 0.12);
      border: 1px solid rgba(240, 173, 78, 0.45);
      padding: 10px 12px;
      border-radius: 8px;
      margin: 10px 0 0 0;
      color: #f7d7a2;
      font-size: 14px;
      display: none;
    }

    .danger {
      background: rgba(220, 53, 69, 0.10);
      border: 1px solid rgba(220, 53, 69, 0.45);
      color: #ffb7bf;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div id="daily-plan-display"></div>
      <div id="risk-banner" class="banner danger"></div>
    </header>

    <main>
      <div class="main-controls">
        <button id="new-trade-btn">➕ 发起新交易</button>
        <button id="edit-plan-btn" class="ghost-btn">✏️ 修改计划</button>
        <button id="export-btn" class="ghost-btn">⬇️ 导出 JSON</button>
      </div>

      <div class="trade-section">
        <h2>进行中的交易</h2>
        <div id="ongoing-trades"></div>
      </div>

      <div class="trade-section">
        <h2>今日已平仓</h2>
        <div id="completed-trades"></div>
      </div>
    </main>
  </div>

  <!-- 每日计划 Modal -->
  <dialog id="plan-modal">
    <h3>每日作战计划</h3>
    <p>先锁定纪律，再开始交易。</p>

    <div class="row">
      <div class="col form-group">
        <label for="market-env">1. 今天的市场环境是什么？</label>
        <select id="market-env">
          <option value="趋势">趋势</option>
          <option value="震荡">震荡</option>
          <option value="不确定">不确定</option>
        </select>
      </div>
      <div class="col form-group">
        <label>2. 我今天允许的方向？</label>
        <div>
          <input type="radio" name="direction" value="只做多" checked /> 只做多
          <input type="radio" name="direction" value="只做空" style="margin-left: 10px;" /> 只做空
          <input type="radio" name="direction" value="多空皆可" style="margin-left: 10px;" /> 多空皆可
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="avoid-case">3. 我今天绝不碰的情况（提示，不做强制）：</label>
      <input type="text" id="avoid-case" placeholder="例如：追涨杀跌、数据前、低流动性" />
    </div>

    <div class="row">
      <div class="col form-group">
        <label for="max-trades">4. 今天最多几单？</label>
        <input type="number" id="max-trades" value="2" min="0" />
      </div>
      <div class="col form-group">
        <label for="daily-max-loss">5. 当日最大亏损（触发后休战）：</label>
        <input type="number" id="daily-max-loss" value="0" min="0" placeholder="例如：1000（0 表示不启用）" />
      </div>
      <div class="col form-group">
        <label for="max-consecutive-losses">6. 最大连续亏损笔数（触发后休战）：</label>
        <input type="number" id="max-consecutive-losses" value="0" min="0" placeholder="例如：2（0 表示不启用）" />
      </div>
    </div>

    <div class="row">
      <div class="col form-group">
        <label for="fee-rate">7. 手续费率（单边，%）：</label>
        <input type="number" id="fee-rate" value="0" min="0" step="0.0001" placeholder="例如：0.04" />
      </div>
      <div class="col form-group">
        <label for="slippage">8. 预估滑点（价格单位）：</label>
        <input type="number" id="slippage" value="0" min="0" step="0.0001" placeholder="例如：0.01" />
      </div>
    </div>

    <button id="lock-plan-btn">锁定今日计划</button>
    <button id="rest-today-btn" style="background-color: var(--red-color); margin-left: 10px;">我需要休息</button>
  </dialog>

  <!-- 下单前状态检查 Modal -->
  <dialog id="readiness-modal">
    <h3>下单前状态检查 (强制)</h3>
    <p class="muted">先保护账户与身体，再开始交易。</p>

    <div class="row">
      <div class="col form-group">
        <label for="sleep-hours">昨晚睡眠（小时）</label>
        <input type="number" id="sleep-hours" min="0" max="24" step="0.5" placeholder="例如：6.5" />
      </div>
      <div class="col form-group">
        <label for="drank-alcohol">今天是否饮酒？</label>
        <select id="drank-alcohol">
          <option value="no" selected>否</option>
          <option value="yes">是</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label for="mood">当前状态</label>
      <select id="mood">
        <option value="稳定" selected>稳定</option>
        <option value="焦虑">焦虑</option>
        <option value="想翻本">想翻本</option>
        <option value="亢奋">亢奋</option>
      </select>
    </div>

    <div id="readiness-warning" class="banner danger" style="display:none;"></div>

    <button id="readiness-confirm-btn">通过检查，继续</button>
    <button id="readiness-cancel-btn" class="ghost-btn" style="margin-left:10px;">取消</button>
  </dialog>

  <!-- 交易准入 Modal -->
  <dialog id="trade-modal">
    <h3>交易准入清单 (V2.2)</h3>

    <div class="position-calculator">
      <h4>仓位计算器</h4>

      <div class="row">
        <div class="col">
          <div class="calc-row"><label>品种 (Symbol):</label><input type="text" id="symbol" placeholder="例如：BTCUSDT" /></div>
        </div>
        <div class="col">
          <div class="calc-row"><label>方向 (Side):</label>
            <select id="side">
              <option value="LONG">做多</option>
              <option value="SHORT">做空</option>
            </select>
          </div>
        </div>
      </div>

      <div class="calc-row"><label>账户总额:</label><input type="number" id="account-balance" placeholder="100000" /></div>
      <div class="calc-row"><label>单笔风险比例 (%):</label><input type="number" id="ris
